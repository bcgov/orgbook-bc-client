<template>
  <div>
    <v-form ref="form" :disabled="loading">
      <div>
        <v-select
          outlined
          dense
          v-model="formData.reason"
          :items="requestTypes"
          label="Reason for contact"
        ></v-select>
      </div>

      <div v-if="formData.reason && formData.reason == 'REGISTER_ORGANIZATION'">
        <p class="font-weight-bold">
          How to add your organization to OrgBook BC
        </p>
        <p>
          Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aenean
          euismod bibendum laoreet. Proin gravida dolor sit amet lacus accumsan
          et viverra justo commodo. Proin sodales pulvinar sic tempor. Sociis
          natoque penatibus et magnis dis parturient montes, nascetur ridiculus
          mus. Nam fermentum, nulla luctus pharetra vulputate, felis tellus
          mollis orci, sed rhoncus pronin sapien nunc accuan eget.
        </p>
      </div>

      <div v-else-if="formData.reason">
        <p class="font-weight-bold" :hidden="incorrectHidden">
          OrgBook BC cannot make corrections to the data. Only the issuing
          organization can do so. Complete the information below and we will
          forward your message to the appropriate organization.
        </p>

        <v-text-field
          outlined
          dense
          v-model="formData.from_name"
          required
          label="Name"
        ></v-text-field>

        <v-text-field
          outlined
          dense
          v-model="formData.from_email"
          label="Email address"
        ></v-text-field>

        <div :hidden="incorrectHidden">
          <v-select
            outlined
            dense
            v-model="formData.error"
            :items="formattedCredentialTypes"
            label="What Information is incorrect?"
          ></v-select>

          <v-text-field
            outlined
            dense
            v-model="formData.identifier"
            label="Identifier (such as the incorporation number, registration number, or licence / permit number)"
          ></v-text-field>
        </div>

        <v-textarea
          outlined
          dense
          v-model="formData.comments"
          :label="labelMessage"
        ></v-textarea>
      </div>

      <v-btn
        id="contactSubmitButton"
        v-if="formData.reason && formData.reason != 'REGISTER_ORGANIZATION'"
        @click="submit"
        depressed
        :disabled="loading"
        aria-label="submit-button"
        >Submit</v-btn
      >
    </v-form>
  </div>
</template>

<script lang="ts">
import { Component, Vue } from "vue-property-decorator";
import { mapActions, mapGetters } from "vuex";
import router from "@/router";
import { ICredentialType } from "@/interfaces/api/v2/credential-type.interface";
import {
  IContactRequest,
  IIncorrectInfoContactRequest,
} from "@/interfaces/api/v2/contact.interface";
import { contactReason } from "@/store/modules/contact";

interface Data {
  formData: {
    reason: string;
  };
}

@Component({
  computed: {
    ...mapGetters(["loading", "credentialTypes"]),
  },
  methods: {
    ...mapActions(["setLoading", "sendFeedback"]),
  },
})
export default class ContactForm extends Vue {
  formData!: IContactRequest | IIncorrectInfoContactRequest;
  credentialTypes!: ICredentialType[];

  setLoading!: (loading: boolean) => void;
  sendFeedback!: (
    feedback: IContactRequest | IIncorrectInfoContactRequest
  ) => Promise<void>;

  data(): Data {
    return {
      formData: { reason: "" },
    };
  }

  get requestTypes(): Array<{ text: string; value: string }> {
    return Object.keys(contactReason).map((key) => ({
      text: contactReason[key],
      value: key,
    }));
  }

  get formattedCredentialTypes(): Array<{ text: string; value: number }> {
    return this.credentialTypes.map((type) => ({
      text: type.description,
      value: type.id,
    }));
  }

  get incorrectHidden(): boolean {
    return this.formData.reason !== "INCORRECT_INFO";
  }

  get labelMessage(): string {
    return this.formData.reason === "INCORRECT_INFO"
      ? "Describe the problem"
      : "Message";
  }

  async submit(e: Event): Promise<void> {
    e.preventDefault();
    const isFormValid = (
      this.$refs.form as Vue & { validate: () => boolean }
    ).validate();
    if (isFormValid) {
      this.setLoading(true);
      await this.sendFeedback(this.formData);
      this.setLoading(false);
      router.push({ name: "Search" });
    }
  }
}
</script>

<style lang="scss" scoped>
#contactSubmitButton {
  background: $primary-color !important;
  color: $white !important;
}
</style>
